/*
 * Copyright 2011 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * 2014 All rights (c)KYGroup Co.,Ltd. reserved.
 * 
 * This software is the confidential and proprietary information
 *  of (c)KYGroup Co.,Ltd. ("Confidential Information").
 * 
 * project	:	Karaoke.APP
 * filename	:	BaseApplication4.java
 * author	:	isyoon
 *
 * <pre>
 * kr.kymedia.karaoke.app
 *    |_ BaseApplication4.java
 * </pre>
 * 
 */

package kr.kymedia.karaoke.app;

import kr.kymedia.karaoke.IKaraoke;
import kr.kymedia.karaoke.IKaraoke2;
import kr.kymedia.karaoke.api.KPItem;
import kr.kymedia.karaoke.api.util.Log2;
import kr.kymedia.karaoke.app.impl.IBaseDialog;
import android.app.AlertDialog;
import android.content.DialogInterface;
import android.os.Bundle;
import android.widget.Toast;

import com.sec.android.iap.lib.helper.SamsungIapHelper;
import com.sec.android.iap.lib.listener.OnPaymentListener;
import com.sec.android.iap.lib.vo.ErrorVo;
import com.sec.android.iap.lib.vo.PurchaseVo;

/**
 * <pre>
 * SamsungIAP추가
 * </pre>
 *
 * @author	isyoon
 * @since	2014. 12. 8.
 * @version 1.0
 */
@Deprecated
public class BaseApplication4 extends BaseApplication3 implements OnPaymentListener {
	final protected String __CLASSNAME__ = "[Iap]" + (new Exception()).getStackTrace()[0].getFileName();

	private static final int MODE = SamsungIapHelper.IAP_MODE_COMMERCIAL;
	private static final String GROUP_ID = "100000102981";
	//private static final String ITEM_ID = "000001015060";
	private SamsungIapHelper mIapHelper = null;

	@Override
	public void onCreate() {
		if (IKaraoke2.DEBUG) Log2.e(__CLASSNAME__, getMethodName());
		// TODO Auto-generated method stub
		super.onCreate();

		mIapHelper = SamsungIapHelper.getInstance(this, MODE);
	}

	/**
	 * 삼성인앱마켓-인앱결제
	 */
	public void requestSamsungINAPP(KPItem info, KPItem list) {
		if (IKaraoke2.DEBUG) Log2.e(__CLASSNAME__, getMethodName() + "isLoginUser:" + isLoginUser());

		if (!isLoginUser()) {
			return;
		}
		
		if (info == null || list == null) {

			if (info == null) {
				showDataError(__CLASSNAME__, getMethodName(), "info", info);
				return;
			}
			
			if (list == null) {
				showDataError(__CLASSNAME__, getMethodName(), "list", list);
				return;
			}
			//KPItem info = KP_nnnn.getInfo();
			//KPItem list = KP_nnnn.getList(KP_index);
		}

		try {
			if (IKaraoke2.DEBUG) Log2.e(__CLASSNAME__, "info - " + info.toString(2));
			if (IKaraoke2.DEBUG) Log2.e(__CLASSNAME__, "list - " + list.toString(2));
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}

		if (info != null) {
			p_passtype = info.getValue("passtype") == null ? p_passtype : info.getValue("passtype");
			if ("Y".equalsIgnoreCase(info.getValue("passtype"))) {
				Bundle args = new Bundle();
				args.putString("message", getString(R.string.errmsg_iap_msg_buy_duplicate));
				getBaseActivity().showDialog2(IBaseDialog.DIALOG_ALERT_MESSAGE_CONFIRM, args);
				return;
			}
		}

		if (getBaseActivity() instanceof PurchaseActivity && list != null) {
			String _itemId = list.getValue("goodscode");
			//String itemType = list.getValue("goodstype");

			//if (getApp() instanceof OnPaymentListener) {
			//	((OnPaymentListener) getApp()).requestSamsungIAP(_itemId);		
			//}
		}

	}

	public void requestSamsungIAP(String _itemId) {
		if (IKaraoke2.DEBUG) Log2.e(__CLASSNAME__, getMethodName() + "isLoginUser:" + isLoginUser());

		if (!isLoginUser()) {
			return;
		}
		
		try {
			mIapHelper.startPayment(GROUP_ID, _itemId, true, this);
		} catch (Exception e) {
			// TODO Auto-generated catch block
			//e.printStackTrace();
			if (IKaraoke2.DEBUG) Log2.e(__CLASSNAME__, Log2.getStackTraceString(e));
		}

	}

	@Override
	public void onPayment(ErrorVo _errorVO, PurchaseVo _purchaseVO) {
		// TODO Auto-generated method stub
		if (IKaraoke2.DEBUG) Log2.e(__CLASSNAME__, getMethodName() + _errorVO.getErrorCode() + "," + _errorVO.getErrorString());

		try {
			AlertDialog.Builder alert = new AlertDialog.Builder(getBaseActivity());
			alert.setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {
				@Override
				public void onClick(DialogInterface dialog, int which) {
					dialog.dismiss();
				}
			});
			//alert.setTitle(_errorVO.getErrorString());
			//alert.setMessage(_purchaseVO.dump());

			// If payment finishes successfully.
			// =================================================================
			if (_errorVO.getErrorCode() == SamsungIapHelper.IAP_ERROR_NONE) {
				//if (getCurrentFragment() instanceof OnPaymentListener) {
				//	((OnPaymentListener) getCurrentFragment()).onPayment(_errorVO, _purchaseVO);
				//}
				//alert.setTitle(_errorVO.getErrorString() + ":" + _errorVO.getErrorCode());
				//alert.setMessage(_purchaseVO.dump());
				
				String goodscode = _purchaseVO.getItemId();
				String tid = _purchaseVO.getPaymentId();
				String is_pay = "Y";
				
				String list = _purchaseVO.getItemDesc();

				KP_4005(goodscode, tid, is_pay, "MARKET", "I", list);
			}
			// =================================================================

			// If payment fails.
			// =================================================================
			else {
				alert.setTitle("ERROR" + ":" + _errorVO.getErrorCode());
				alert.setMessage(_errorVO.getErrorString());
			} // =================================================================
			alert.show();
		} catch (Exception e) {
			// TODO Auto-generated catch block
			//e.printStackTrace();
			if (IKaraoke2.DEBUG) Log2.e(__CLASSNAME__, Log2.getStackTraceString(e));
		}
	}


}

